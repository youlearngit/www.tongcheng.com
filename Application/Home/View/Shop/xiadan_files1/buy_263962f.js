function subStrToNum(t,e){var a="";if(e)for(var i=e.split("|"),n=0;n<i.length;n++)if(i[n].indexOf(t)>=0){var s=i[n].split(":");a=s[1]}return a}function IsNumeric(t){var e,a="0123456789",n=!0;if(isNaN(t))n=!1;else{for(i=0;i<t.length&&1==n;i++)e=t.charAt(i),-1==a.indexOf(e)&&(n=!1);String(parseInt(t)).length<String(t).length&&(n=!1)}return n}function isRealphone(t){var e=/^1[34578]\d{9}$/;return e.test(t)?!0:!1}function inArray(t,e){if(e instanceof Array)for(var a=0;a<e.length;a++)if(e[a]==t)return!0;return!1}function inputOnfocus(t){$(t).hasClass("hover")||$(t).addClass("hover"),$(t).hasClass("error")&&$(t).removeClass("error"),$(t).next().hasClass("error")&&$(t).next().removeClass("error"),$(t).keyup(function(){$(t).prev().hide()})}function inputOnblur(t){""==$(t).val()&&($(t).removeClass("hover"),$(t).prev().show())}function hidePhone(t){var e=isRealphone(t);if(e){var a=t.substr(0,3),i=t.substr(-4,4),n=a+"****"+i;return n}return!1}function tabCutover(t,e){$(t).addClass("current").siblings().removeClass("current"),$(t).parent().next().find("."+e).show().siblings().hide()}function addHover(t){t.hasClass("hover")||(t.addClass("hover"),t.val(""))}function removeHover(t,e){""==t.val()&&(t.removeClass("hover"),t.val(e))}function cookieStrToArr(t){t=t.substr(0,t.length-1),arr1=t.split("|");for(var e=new Array,a=0;a<arr1.length;a++)e[a]=arr1[a].split("=");return e}function removeHTMLTag(t){return t=t.replace(/<\/?[^>]*>/g,""),t=t.replace(/[ | ]*\n/g,"\n"),t=t.replace(/&#x20;/gi,"")}function _this(t){if(t.currentTarget)var e=$(t.currentTarget);else var e=$(t);return e}function getQueryString(t){var e=new RegExp("(^|&)"+t+"=([^&]*)(&|$)","i"),a=window.location.search.substr(1).match(e);return null!=a?unescape(a[2]):null}var buy={api:{delGood:"/order/cart/del/",getSub:"/order/buy/getsubgoods/",toFavor:"/order/cart/cart2fav/",actCoupon:"/account/charge/promotioncode/",yanzm:"/account/charge/promotioncodecaptcha/",couponList:"/order/buy/getcouponlist/",getTravelCondition:"/order/pay/getgoodsactivity",setTravelCondition:"/order/pay/setgoodsactivity"},editGoodId:0,coupArray:"",travelCheck:"",init:function(){"buy"==_switch?(this.pageReady(),this.getTravelAuth(),$("#datepicker").click(function(){$("#datepicker").datetimepicker("show")})):(this.submitStatus(),this.priceTotal()),$(".cart-thead>.checkbox input").click(function(t){var e=$(t.currentTarget).attr("checked");buy.toggleAll(e)}),$(".plus").click(function(t){buy.numPlus(t)}),$(".minus").click(function(t){buy.numMinus(t)}),$(".quantity-number input").blur(function(t){buy.numEnter(t)}),$(".choose-title").click(function(t){buy.getSubGoods(t)}),$("#sub_form").submit(function(){return buy.orderCheck()}),$(".cart-list .checkbox input").click(function(){buy.payAble(),receive.visible(),buy.priceTotal(),buy.coupStatus()}),this.plusBut()},getTravelAuth:function(){var t=$("#travel_block"),e=t.attr("data-good-id"),a=this.api.getTravelCondition,i=this;t.length>0&&$.ajax({url:a,type:"POST",dataType:"json",data:{goods_id:e},success:function(e){if(1==e.status){var e=e.data;if("1000"!=e.ischeck_date)t.find(".cl:first").remove();else{var a={language:"zh-CN",format:"yyyy-mm-dd",minView:2,autoclose:!0},n=new Date,s=n.getFullYear()+"-"+(n.getMonth()+1)+"-"+n.getDate();if(e.start_date){var r=new Date(e.start_date);if(r>n)var o=e.start_date;else var o=s;a.startDate=o}else a.startDate=s;e.end_date&&(a.endDate=e.end_date);var l=new Date(a.startDate.replace(/-/g,"/"));if("is_weekday"==e.date_type)if(a.daysOfWeekDisabled="1,2,3,4,5",6!=l.getDay()&&0!=l.getDay())var d=parseInt(l.getDate())+(6-parseInt(l.getDay()));else var d=l.getDate();if("is_workday"==e.date_type)if(a.daysOfWeekDisabled="0,6",6==l.getDay())var d=parseInt(l.getDate())+2;else if(0==l.getDay())var d=parseInt(l.getDate())+1;else var d=l.getDate();if("is_allday"==e.date_type)var d=l.getDate();a.initialDate=l.getFullYear()+"-"+(l.getMonth()+1)+"-"+d,$("#datepicker").datetimepicker(a)}"1000"!=e.ischeck_customer&&t.find(".cl").not(":first").remove(),"1000"!=e.ischeck_customer&&"1000"!=e.ischeck_date?($("#travel_block").remove(),i.travelCheck=!1):($("#travel_block").show(),i.travelCheck=!0)}else console.log("接口返回错误"),$("#travel_block").remove(),i.travelCheck=!1},error:function(){console.log("网络请求失败"),$("#travel_block").remove(),i.travelCheck=!1}})},travelAuthCheck:function(){var t=$("#datepicker"),e=$('input[name="ture_name"]'),a=$('input[name="card_id"]'),i=$('input[name="mobile"]');if(this.travelCheck){if(t.length>0){if(""==t.val())return $("#datepicker").next(".tips").addClass("error"),!1;$("#datepicker").next(".tips").removeClass("error")}if(e.length>0){if(!is_name(e.val()))return e.next(".tips").addClass("error"),!1;e.next(".tips").removeClass("error")}if(a.length>0){if(!is_identity(a.val()))return a.next(".tips").addClass("error"),!1;a.next(".tips").removeClass("error")}if(i.length>0){if(!isRealPhone(i.val()))return i.next(".tips").addClass("error"),!1;i.next(".tips").removeClass("error")}}return!0},toggleAll:function(t){var e=$(".cart-list>.checkbox input:not(':disabled')");t?e.attr("checked","checked"):e.attr("checked",""),this.priceTotal(),this.submitStatus()},submitStatus:function(){var t=$(".cart-list>.checkbox input:checked").length;t>0?($('.buy-botton input[type="submit"]').removeAttr("disabled"),$('.buy-botton input[type="submit"]').removeClass("disabled")):($('.buy-botton input[type="submit"]').attr("disabled","disabled"),$('.buy-botton input[type="submit"]').addClass("disabled"))},plusBut:function(){for(var t=$(".quantity .quantity-number input"),e=0;e<t.length;e++){var a=parseInt($(t[e]).val()),i=parseInt($(t[e]).attr("user_can_bought"));a>=i&&$(t[e]).next(".plus").addClass("disabled")}},cartEmpty:function(){var t=$(".cart-list").length;if(0==t){$(".narrow-step").next("form").remove();var e='<div class="cart-null">							<i class="narrow-icon"></i><span>您的购物车还是空的，赶紧行动吧！</span>							<a href="/">立即去团购</a>						</div>';return $(".narrow-step").after(e),!0}return!1},isSpike:function(){return"buy"!=_switch?!1:"-1"==spike?!0:void 0},pageReady:function(){if(amount){if(isNaN(amount)){var t=0,e="";for(var a in amount)t+=parseInt(amount[a]),e+=a+":"+amount[a]+"|";e=e.substr(0,e.length-1),$(".quantity").attr("pronum",t),$(".quantity .quantity-number input").val(t),$('.quantity input[title="total_num"]').val(t),$('.quantity input[title="sub_num"]').val(e),$.ajax({type:"get",url:this.api.getSub,datatype:"json",data:{goods_id:$(".cart-list").attr("goods_id")},success:function(t){var e="";e+="分店和数量"==pop.popTitle?'<dl class="choose-content"><dt><span class="left">分店</span><span class="right">数量</span></dt>':'<dl class="choose-content"><dt><span class="left">类型</span><span class="right">数量</span></dt>';for(var a in amount)e+='<dd><span class="left" title="'+t.data[a].title+'">'+t.data[a].title+'</span><span class="right">'+parseInt(amount[a])+"</span></dd>";e+="分店和数量"==pop.popTitle?'<dd class="modify"><a href="javascript:void(0);" hint="分店" onclick="buy.getSubGoods(this)">修改</a></dd></dl>':'<dd class="modify"><a href="javascript:void(0);" hint="类型" onclick="buy.getSubGoods(this)">修改</a></dd></dl>',$(".choose-title").replaceWith($(e))},error:function(t){console.log(t.msg)}})}else{var t=amount;$(".quantity").attr("pronum",t),$(".quantity .quantity-number input").val(t)}var i=$(".quantity .quantity-number input").attr("user_can_bought"),n=$(".quantity .quantity-number input").attr("min_per_user");0>=n&&(n=1),n>=t?($(".minus").addClass("disabled"),$(".plus").removeClass("disabled")):t>n&&i>t?($(".minus").removeClass("disabled"),$(".plus").removeClass("disabled")):t>=i&&($(".minus").removeClass("disabled"),$(".plus").addClass("disabled"))}else if(getQueryString("num")){var t=getQueryString("num"),s=$(".quantity-number");if(s.length>0){var r=s.find("input").attr("user_can_bought"),o=s.find("input").val();t>o&&(parseInt(t)>parseInt(r)?(alert("最多购买"+r+"件"),s.find(".plus").addClass("disabled"),s.find("input").val(r)):parseInt(t)==parseInt(r)?(s.find("input").val(t),s.find(".plus").addClass("disabled")):s.find("input").val(t),s.find(".minus").removeClass("disabled"))}}activity_id&&$('.cart-discount select option[value="'+activity_id+'"]').attr("selected","selected"),this.priceTotal()},priceTotal:function(){var t=$(".total-price b"),e=0;if("buy"==_switch){var a=$(".cart-list .quantity").attr("pronum"),i=$(".cart-list .quantity").attr("price_unit");e=accMul(a,i)}else for(var n=$(".cart-list .checkbox input:checked").parent().siblings(".price").find("em:last"),s=0;s<n.length;s++)e=accAdd(e,parseFloat($(n[s]).text()));var r=buy.activity();if(r){var o=accSub(e,r);o>0?($(".cart-thead .prefer").html("优惠"),$(".cart-list .prefer").html("<em>&yen</em>"+o)):($(".cart-thead .prefer").html(""),$(".cart-list .prefer").html("")),$(".cart-list .price em:last").html(r)}else r=e,"buy"==_switch&&($(".cart-list .prefer").html(""),$(".cart-list .price em:last").html(r));var l=buy.coupSel(r);return t.html(l),l},numMinus:function(t){if(evt=$(t.currentTarget?t.currentTarget:t),!evt.hasClass("disabled")){evt.siblings(".plus").hasClass("disabled")&&evt.siblings(".plus").removeClass("disabled");{var e=parseInt(evt.siblings("input").attr("value")),a=parseInt(evt.siblings("input").attr("min_per_user"));parseFloat(evt.siblings("input").attr("price_unit"))}IsNumeric(e)&&(e--,evt.siblings("input").attr("value",e),a?a>=e&&evt.addClass("disabled"):1>=e&&evt.addClass("disabled")),this.toPrice(evt.parents(".cart-list"),e),buy.coupStatus()}},numPlus:function(t){evt=$(t.currentTarget?t.currentTarget:t),evt.siblings(".minus").hasClass("disabled")&&evt.siblings(".minus").removeClass("disabled");{var e=parseInt(evt.siblings("input").attr("value")),a=parseInt(evt.siblings("input").attr("user_can_bought"));parseFloat(evt.siblings("input").attr(".price_unit")),parseInt(evt.siblings(".quantity-limit").find(".max_limit em").html())}return evt.hasClass("disabled")?void(e>=a&&alert("最多购买"+a+"件")):(IsNumeric(e)?(e++,evt.prev("input").attr("value",e),e>=a&&evt.addClass("disabled")):pop.plusOne(evt),this.toPrice(evt.parents(".cart-list"),e),void buy.coupStatus())},numEnter:function(t){evt=$(t.currentTarget?t.currentTarget:t);{var e=evt.attr("value"),a=parseInt(evt.attr("min_per_user")),i=(parseFloat(evt.attr(".price_unit")),parseInt(evt.attr("user_can_bought")));parseInt(evt.attr("max_per_user"))}0>=a&&(a=1),IsNumeric(e)?(a>=e?(e=a,evt.siblings(".minus").addClass("disabled"),evt.siblings(".plus").removeClass("disabled")):e>i?(e=i,alert("最多可购买"+i+"件"),evt.siblings(".plus").addClass("disabled"),evt.siblings(".minus").removeClass("disabled")):e==i?(evt.siblings(".plus").addClass("disabled"),evt.siblings(".minus").removeClass("disabled")):(evt.siblings(".plus").removeClass("disabled"),evt.siblings(".minus").removeClass("disabled")),a==i&&(evt.siblings(".plus").addClass("disabled"),evt.siblings(".minus").addClass("disabled")),evt.attr("value",e)):(e=a,evt.attr("value",a),evt.siblings(".minus").addClass("disabled"),i>a?evt.siblings(".plus").removeClass("disabled"):evt.siblings(".plus").addClass("disabled")),this.toPrice(evt.parents(".cart-list"),e),buy.coupStatus()},toPrice:function(t,e){t.length&&(t.find(".quantity").attr("proNum",e),this.editGoodId=t.attr("goods_id"),this.priceItem(),this.priceTotal())},priceItem:function(t){if(t)var e=this.editGoodId;else var e=this.editGoodId;var a=$('.cart-list[goods_id="'+e+'"]'),i=parseInt(a.find(".quantity").attr("proNum")),n=parseFloat(a.find(".quantity").attr("price_unit")),s=a.find(".price").find("em:eq(1)");s.html(accMul(i,n))},delGood:function(t){var e=$(t),a=e.parents(".cart-list").attr("goods_id");$.ajax({type:"get",url:this.api.delGood,datatype:"json",data:{goods_id:a},success:function(t){0==t.status?(e.parents(".cart-list").remove(),receive.visible(),buy.coupStatus(),buy.priceTotal(),buy.cartEmpty(),cartUp()):alert(t.errmsg)}})},addFavor:function(t){var e=$(t),a=e.parents(".cart-list").attr("goods_id");$.ajax({type:"get",url:this.api.toFavor,datatype:"json",data:{goods_id:a},success:function(t){0==t.status?(e.parents(".cart-list").remove(),receive.visible(),buy.coupStatus(),buy.priceTotal()):alert(t.errmsg)}})},getSubGoods:function(t){if(t.currentTarget)var e=$(t.currentTarget);else var e=$(t);var a=e.parents(".cart-list").attr("goods_id"),i=e.attr("hint");if("类型"==i)var n="类型和数量";else var n="分店和数量";a&&(this.editGoodId=a,$.ajax({type:"get",url:this.api.getSub,datatype:"json",data:{goods_id:a},success:function(t){t.result&&t.data&&(pop.dataFill(t,n),pop.show())},error:function(t){console.log(t.msg)}}))},payAble:function(){for(var t=$(".cart-list .checkbox input"),e=!1,a=0;a<t.length;a++)1==$(t[a]).attr("checked")&&(e=!0);0==e?$('.buy-botton input[type="submit"]').addClass("disabled"):$('.buy-botton input[type="submit"]').removeClass("disabled")},orderCheck:function(){if(!this.travelAuthCheck())return!1;var t=$('.buy-botton input[type="submit"]').hasClass("disabled");if(t)return!1;var e=$(".cart-list .checkbox input").not(":checked").parents(".cart-list"),a=e.find('input[type="text"]'),i=e.find('input[type="hidden"]');a.attr("disabled","disabled"),i.attr("disabled","disabled");for(var n=$('.cart-list input[type="hidden"][title="total_num"]:not(":disabled")'),s=0;s<n.length;s++){var r=$(n[s]).val();if(!r)return hint=n.prev(".choose-title").attr("hint"),alert("分店"==hint?"请选择分店和数量":"请选择类型和数量"),!1;var o=$(n[s]).parents(".cart-list").attr("goods_id");if(!pop.subFinish(o))return!1}if(!userid){if("buy"==_switch)var l=$(".cart-list .quantity").attr("pronum"),d=window.location.href+"&num="+l;else var d=window.location.href;return window.location.href="/account/login/?url="+escape(d),!1}if(0==$(".photo").length)return alert("请先绑定手机"),!1;if($("#receive").length>0&&receive.has_deliver()){var p=$('input[name="address"]').val();if(!p){if(!$(".buy-address li.current").attr("data-addrid"))return alert("请先选择收货地址"),!1;$('input[name="address"]').val($(".buy-address li.current").attr("data-addrid"))}}var c=$("#delivery_memo input").val();"可告诉商家您的特殊需求（选填）"==c&&$("#delivery_memo input").attr("value","")},actCoupon:function(){var t=$(".new-coupon-form .cl:eq(0) input").val(),e=$(".new-coupon-form .cl:eq(1) input").val();if(""==t)return $(".new-coupon-form .cl:eq(0) .error span").html("请输入抵用券密码"),$(".new-coupon-form .cl:eq(0) .error").show(),void $(".new-coupon-form .cl:eq(0) .correct").hide();var a=/[0-9]+/;return a.test(t)?void $.ajax({type:"get",url:this.api.actCoupon,datatype:"json",data:{code:t,captcha:e},success:function(t){if(0==t.state)$(".new-coupon-form .cl:eq(0) .correct").show(),$(".new-coupon-form .cl:eq(0) .error").hide(),buy.coupUp(),setTimeout(function(){$(".new-coupon>div").fadeOut(300,function(){$(".new-coupon>a").fadeIn(100,function(){$(".new-coupon-form .tips").hide(),$(".new-coupon-form .yzm ").hide()})})},5e3);else if($(".new-coupon-form .cl:eq(0) .error span").html(t.msg),$(".new-coupon-form .cl:eq(0) .error").show(),$(".new-coupon-form .cl:eq(0) .correct").hide(),buy.couponyzm=t.codeshow,t.codeshow?$(".new-coupon-form .yzm").show():$(".new-coupon-form .yzm").hide(),!t.retry){var e=(new Date).getTime();$(".new-coupon-form .yzm img").attr("src",buy.api.yanzm+"?"+e)}}}):($(".new-coupon-form .cl:eq(0) .error span").html("抵用券密码格式不正确"),$(".new-coupon-form .cl:eq(0) .error").show(),void $(".new-coupon-form .cl:eq(0) .correct").hide())},refreshyzm:function(){var t=(new Date).getTime();$(".new-coupon-form .yzm img").attr("src",buy.api.yanzm+"?"+t)},coupUp:function(){var t="";"buy"==_switch&&(t=$(".cart-list").attr("goods_id")),$.ajax({type:"get",url:this.api.couponList,datatype:"json",data:{goods_id:t},success:function(t){var e=t.data;if(buy.coupArray=e,e){$(".cart-coupon .coupon-title a").append("<em>"+e.length+"</em>"),$("#noCoup").prevAll().remove();for(var a in e){var i='<p class="coupon-content">									<label>										<input value="'+e[a].coupon_id+'" type="radio" hidefocus="true" class="c-radio"  name="coupon" onclick="buy.priceTotal()" coup-value="'+e[a].value+'" />										<span class="c-money"><em>&yen;</em>'+e[a].value+"</span>";e[a].price_limit&&(i+='<span class="c-text">单价<b><em>&yen;</em>'+e[a].price_limit+"</b>以上可用</span>"),e[a].total_limit>0&&(i+='<span class="c-text">',e[a].price_limit&&(i+=","),i+="总价<b><em>&yen;</em>"+e[a].total_limit+"</b>以上可用</span>"),i+="</label>								  </p>",$(".coupon-list").prepend($(i))}}else $("#noCoup").prev().remove(),$("#noCoup").before('<p class="nonecoup" style="padding-left: 10px;">暂时没有可用的抵用券</p>');buy.coupStatus()}})},coupToggle:function(t){$(t).toggleClass("open"),$(".coupon-list").slideToggle(500),$(".new-coupon-form p.tips").hide()},coupSel:function(t){if(!($(".cart-coupon:visible").length>0))return t;if(coupSeled=$('.coupon-content input[name="coupon"]:checked'),!coupSeled.attr("coup-value"))return t;var e=coupSeled.attr("coup-value");if(total_limit=coupSeled.attr("total-limit"),!(total_limit>t)){if(t>e)var a=accSub(t,e);else var a=0;return a}alert("选用的抵用券不在满足条件，请选择其他"),$("#noCoup input").attr("checked",!0)},coupShow:function(t){t?$(".cart-coupon").show():$(".cart-coupon").hide()},coupStatus:function(){var t=this.coupArray;if("buy"==_switch)var e=$(".cart-list");else var e=$(".cart-list .checkbox input:checked").parents(".cart-list"),a=e.length;var i=new Array;for(var n in t)for(var s=0;s<e.length;s++){if(t[n].allow_cat&&t[n].allow_cat.length>0){var r=$(e[s]).attr("goods_cat");if(!inArray(r,t[n].allow_cat))continue}if(t[n].allow_channel&&t[n].allow_channel.length>0){var o=$(e[s]).attr("goods_channel");if(!inArray(o,t[n].allow_channel))continue}if(t[n].goods_limit&&t[n].goods_limit.length>0){var l=$(e[s]).attr("goods_id");if(!inArray(l,t[n].goods_limit))continue}if(t[n].cities&&t[n].cities.length>0){var d=$(e[s]).attr("city_id");if(!inArray(d,t[n].cities))continue}if(t[n].price_limit){var p=$(e[s]).find(".quantity").attr("price_unit");if(parseFloat(p)<parseFloat(t[n].price_limit))continue}if(t[n].total_limit){var p=$(e[s]).find(".price").find("em:last").html();if(parseFloat(p)<parseFloat(t[n].total_limit))continue}if("cart"==_switch&&1!=a&&t[n].value){var p=$(e[s]).find(".price").find("em:last").html();if(parseFloat(p)<parseFloat(t[n].value))continue}i.push(t[n]);break}$('.coupon-content:not("#noCoup")').hide();for(var n=0;n<i.length;n++)$('input[value="'+i[n].coupon_id+'"]').parents(".coupon-content").show();i.length>0?($(".nonecoup").hide(),$(".cart-coupon .coupon-title a em").html(i.length)):($(".nonecoup").show(),$(".cart-coupon .coupon-title a em").remove()),"buy"==_switch&&"0"!=coupon_id&&""!=coupon_id&&($('.coupon-list input[value="'+coupon_id+'"]').attr("checked","checked"),buy.coupToggle($(".cart-coupon .coupon-title a")),this.priceTotal(),coupon_id="");var c=$(".coupon-content input:checked").parents(".coupon-content");"none"==c.css("display")&&($("#noCoup input").attr("checked","checked"),this.priceTotal())},activity:function(){var t=$('select[name="activity"] option:selected');if(t.length>0){var e=t.attr("activityType"),a=t.attr("coupon-show"),i=$(".cart-list>.quantity").attr("pronum"),n=$(".cart-list>.quantity").attr("price_unit");if($(".cart-list .money p").html("<em>&yen;</em>"+n),$(".cart-list .price em:last").html(accMul(i,n)),this.coupShow(a),10==e){var s=t.attr("amount"),r=t.attr("price");if(s){if(parseInt(i)<=parseInt(s))return accMul(i,r);var o=accMul(s,r),l=accSub(i,s),d=accMul(l,n),p=accAdd(o,d);return p}return accMul(i,r)}if(7==e){var c=parseFloat($(".cart-list .price em:last").html()),u=t.attr("free_money"),h=t.attr("full_money");return h>c?(alert("消费额度不能达到满减活动的要求,请选择其他优惠信息"),$('select[name="activity"]').find("option:last").attr("selected",!0),this.coupShow(!0),accMul(i,n)):accSub(c,u)}if(-1==e){var v=t.attr("derate"),l=accSub(n,v);return $(".cart-list .money p").html("<em>&yen;</em>"+l),$(".cart-list .price em:last").html(accMul(i,l)),accMul(i,l)}var c=parseFloat($(".cart-list .price em:last").html()),h=t.attr("full_money");return h>c?(alert("消费额度不能达到该返券活动的要求,请选择其他优惠信息"),$('select[name="activity"]').find("option:last").attr("selected",!0),this.coupShow(!0),accMul(i,n)):c}return!1}},receive={api:{list:"/account/address/getlist/",setDefault:"/account/address/setdefault/",updateAddr:"/account/address/modify/",newAddr:"/account/address/add/"},editAddrId:0,init:function(){this.list(),this.province(),this.city(),this.town(),$("#addrSubmit").click(function(t){receive.sendAddr(t)}),this.visible()},visible:function(){var t=this.has_deliver();t?this.insight():this.outsight()},has_deliver:function(){if("buy"==_switch)var t=$(".cart-list");else var t=$(".cart-list .checkbox input:checked").parents(".cart-list");for(var e=!1,a=0;a<t.length;a++)2==$(t[a]).attr("goods_type")&&(e=!0);return e},insight:function(){$("#receive").show(),$('input[name="address_id"]').attr("disabled",!1)},outsight:function(){$("#receive").hide(),$('input[name="address_id"]').attr("disabled",!0)},list:function(){$.ajax({type:"get",url:this.api.list,datatype:"json",success:function(t){if(0==t.status&&t.data.length>0){var e=t.data,a=$('<ul class="buy-address cl"></ul>');for(var i in e){var n=receive.upaddrDom(e[i]);a.append(n)}if(a.append(receive.newLi()),$(".addressi-form").before(a),t.data.length>=4){var s=$('<a hidefocus="true" href="javascript:void(0);"><i class="narrow-icon"></i>显示全部地址</a>');s.click(function(t){$(t.currentTarget).remove(),$(".buy-address").removeAttr("style")}),s.appendTo("#delivery_memo"),$(".buy-address").css("overflow","hidden"),$(".buy-address").css("height","141px")}"buy"==_switch&&address_id?(chosen=$('li[data-addrid="'+address_id+'"]'),chosen.length>0?(receive.selectAddr(chosen),$("#receive .coupon-title>a").remove(),$(".buy-address").removeAttr("style")):receive.selectAddr($(".buy-address li:first"))):receive.selectAddr($(".buy-address li:first"))}else $(".addressi-form").show()}})},upaddrDom:function(t){var e=$('<li data-addrId="'+t.id+'" onclick="receive.selectAddr(this)">');t.is_default?($('input[name="address_id"]').val(t.id),e.addClass("current"),default_text="默认地址",$(".buy-address .default").html("设为默认")):default_text="设为默认",defaultBut=$('<a class="default" hidefocus="true" href="javascript:void(0);">'+default_text+"</a>"),defaultBut.click(function(t){receive.setDefault(t)}),e.append(defaultBut),e.append('<p class="name"><strong>'+t.username+"</strong>(收)</p>");var a=t.province_name+t.city_name+t.town_name+t.address;if(t.town_name)var i=38-t.province_name.length-t.city_name.length-t.town_name.length;else var i=38-t.province_name.length-t.city_name.length;return t.address.length>i&&(t.address=t.address.substr(0,i)+"…"),e.append(t.town_name?'<p class="address"><span title="'+a+'"><font province_id="'+t.province+'">'+t.province_name+'</font><font city_id="'+t.city+'">'+t.city_name+'</font><font town_id="'+t.town+'">'+t.town_name+"</font><font>"+t.address+"</font></span><em>"+t.mobilephone+'</em><em style="display: none;">'+t.code+"</em></p>":'<p class="address"><span title="'+a+'"><font province_id="'+t.province+'">'+t.province_name+'</font><font city_id="'+t.city+'">'+t.city_name+"</font><font>"+t.address+"</font></span><em>"+t.mobilephone+'</em><em style="display: none;">'+t.code+"</em></p>"),e.append('<a class="modify" hidefocus="true" href="javascript:void(0);" onclick="receive.editAddr(this,event)"><i></i><span>修改</span></a>'),e.append('<i class="icon"></i>'),e.hover(function(t){$(t.currentTarget).addClass("hover")},function(t){$(t.currentTarget).removeClass("hover")}),e},newLi:function(){var t=$('<li><a class="new-address" href="javascript:void(0);"><i></i><span>使用新地址</span></a></li>');return t.hover(function(t){$(t.currentTarget).addClass("hover")},function(t){$(t.currentTarget).removeClass("hover")}),t.click(function(t){receive.selectAddr(t),receive.newAddr(),$(".addressi-form").show()}),t},setDefault:function(t){var e=$(t.currentTarget),a=e.parent().attr("data-addrId"),i=e.html();"设为默认"==i&&$.ajax({type:"get",url:this.api.setDefault,datatype:"json",data:{address_id:a},success:function(t){0==t.status&&($(".buy-address li .default").html("设为默认"),e.html("默认地址"))}})},selectAddr:function(t,e){evt=t.currentTarget?$(t.currentTarget):e?e:$(t),$(".buy-address li").removeClass("current"),evt.addClass("current"),evt.attr("data-addrid")?($(".addressi-form").hide(),$('input[name="address_id"]').val(evt.attr("data-addrid"))):$('input[name="address_id"]').val("")},editAddr:function(t,e){e?e.stopPropagation():window.event.cancelBubble=!0;var a=$(t).parent().attr("data-addrId"),i=$(t).siblings(".address"),n=i.find("span>font:eq(0)").attr("province_id"),s=i.find("span>font:eq(1)").attr("city_id"),r=i.find("span>font:eq(2)").attr("town_id"),o=i.find("span>font:last").html(),l=i.children("em:first").html(),d=i.children("em:last").html(),p=$(t).siblings(".name").find("strong").html(),c=$(t).siblings(".default").html();this.editAddrId=a,this.city(),this.town(),$('div[data-select="province"] .handy-input').attr("province_id",n),$('div[data-select="province"] .handy-input').html(province[n]),$('div[data-select="city"] .handy-input').attr("city_id",s),$('div[data-select="city"] .handy-input').html(city[n][s]),$('div[data-select="town"] .handy-input').attr("town_id",r),$('div[data-select="town"] .handy-input').html(area[s][r]),$('input[name="street"]').val(o),$('input[name="code"]').val(d),$('input[name="mobile"]').val(l),$('input[name="sendUser"]').val(p),$(".input-warp .tips").removeClass("error"),"默认地址"==c?$("#addrDefault input").attr("checked","checked"):$("#addrDefault input").attr("checked",""),$(".addressi-form").show()},newAddr:function(){$(".input-warp input").val(""),this.province(),this.city(),this.town(),$(".input-warp .tips").removeClass("error"),this.editAddrId=0},province:function(){var t=$('div[data-select="province"] .handy-dropdowncen'),e=$('div[data-select="province"] .handy-input');for(var a in province){var i=$('<a province_id="'+a+'" href="javascript:void(0);" hidefocus="true">'+province[a]+"</a>");i.click(function(t){var a=$(t.currentTarget).attr("province_id"),i=$(t.currentTarget).html();e.html(i),e.attr("province_id",a),e.attr("title",i),receive.city(),receive.town()}),t.append($(i))}},city:function(){var t=$('div[data-select="province"] .handy-input').attr("province_id"),e=$('div[data-select="city"] .handy-dropdowncen'),a=$('div[data-select="city"] .handy-input');if(t){e.html("");var i=0;for(var n in city[t]){0==i&&(a.html(city[t][n]),a.attr("city_id",n),i=1);var s=$('<a city_id="'+n+'" href="javascript:void(0);" hidefocus="true">'+city[t][n]+"</a>");s.click(function(t){var e=$(t.currentTarget).attr("city_id"),i=$(t.currentTarget).html();a.html(i),a.attr("city_id",e),a.attr("title",i),receive.town()}),e.append($(s))}}else console.log("收货地址城市初始化失败")},town:function(){var t=$('div[data-select="city"] .handy-input').attr("city_id"),e=$('div[data-select="town"] .handy-dropdowncen'),a=$('div[data-select="town"] .handy-input');if(t){e.html("");var i=0;for(var n in area[t]){0==i&&(a.html(area[t][n]),a.attr("town_id",n),i=1);var s=$('<a town_id="'+n+'" href="javascript:void(0);" hidefocus="true">'+area[t][n]+"</a>");s.click(function(t){var e=$(t.currentTarget).attr("town_id"),i=$(t.currentTarget).html();a.html(i),a.attr("town_id",e),a.attr("title",i)}),e.append($(s))}}else console.log("收货地址区县初始化失败")},addrCheck:function(){var t=!0,e=$('div[data-select="city"] .handy-input').attr("city_id"),a=$('div[data-select="town"] .handy-input').attr("town_id");(0==e||0==a)&&($(".select>.input-warp .tips").addClass("error"),t=!1),$.trim($('input[name="street"]').val()).length<5?($('input[name="street"]').next(".tips").addClass("error"),t=!1):$('input[name="street"]').next(".tips").removeClass("error"),""==$.trim($('input[name="sendUser"]').val())?($('input[name="sendUser"]').next(".tips").addClass("error"),t=!1):$('input[name="sendUser"]').next(".tips").removeClass("error"),-1!=$.trim($('input[name="code"]').val()).search(/[^\d]/)||6!=$.trim($('input[name="code"]').val()).length?($('input[name="code"]').next(".tips").addClass("error"),t=!1):$('input[name="code"]').next(".tips").removeClass("error");var i=/(^(\d{3,4}\-)?\d{7,8}(\-\d{3,4})?$)|(^(13|14|15|17|18)\d{9}$)/;return i.test($.trim($('input[name="mobile"]').val()))?$('input[name="mobile"]').next(".tips").removeClass("error"):($('input[name="mobile"]').next(".tips").addClass("error"),t=!1),t},sendAddr:function(t){var e=receive.addrCheck();$(t.currentTarget).attr("disabled","disabled");var a={province:$('div[data-select="province"] .handy-input').attr("province_id"),city:$('div[data-select="city"] .handy-input').attr("city_id"),town:$('div[data-select="town"] .handy-input').attr("town_id"),address:removeHTMLTag($.trim($('input[name="street"]').val())),zipcode:$.trim($('input[name="code"]').val()),username:removeHTMLTag($.trim($('input[name="sendUser"]').val())),mobile:$.trim($('input[name="mobile"]').val())};if(a.is_default=$("#addrDefault input").attr("checked")?1:0,e){if(0==this.editAddrId)sendURI=this.api.newAddr;else{sendURI=this.api.updateAddr,a.address_id=this.editAddrId;var i=$('li[data-addrid="'+this.editAddrId+'"]')}$.ajax({type:"post",url:sendURI,datatype:"json",data:a,success:function(e){if(0==e.status){a.id=e.data.address_id,a.province_name=province[a.province],a.city_name=city[a.province][a.city],a.town_name=area[a.city][a.town],a.mobilephone=a.mobile,a.code=a.zipcode;var n=receive.upaddrDom(a);$(".buy-address").length<=0&&($(".addressi-form").before('<ul class="buy-address cl"></ul>'),$(".buy-address").append(receive.newLi())),$(".buy-address li").removeClass("current"),n.addClass("current"),i?i.replaceWith(n):$(".buy-address").prepend(n),receive.selectAddr("",n),$(".addressi-form").hide(),$(t.currentTarget).attr("disabled",!1)}}})}else $(t.currentTarget).attr("disabled",!1)},editCancel:function(){if(!$(".buy-address li").length){var t=receive.newLi();$(".addressi-form").before('<ul class="buy-address cl"></ul>'),$(".buy-address").append(t)}$(".addressi-form").hide()}},pop={popLayer:$("#product-type"),dataBox:$(".pop .type-branch"),popTitle:$(".pop-title").html(),subSet:new Array,init:function(){$(".pop .tb-button input").click(function(){pop.subOk()}),$(".pop .pop-close").click(function(){pop.close()})},show:function(){this.popLayer.css("margin-top","-"+Math.round(this.popLayer.height()/2)+"px"),this.popLayer.show(),$("body").append($('<div id="shadowlayer" style="display:block;"></div>')),this.plusSate()},close:function(){$("#shadowlayer").remove(),this.popLayer.hide(),$(".branch-select").remove()},plusSate:function(){for(var t=$("#product-type .type-branch dd"),e=0;e<t.length;e++){var a=$(t[e]).attr("user_can_bought"),i=$(t[e]).attr("min_per_user");0>=i&&(i=1);var n=$(t[e]).find(".tb-number input").val();""==n&&($(t[e]).find(".tb-number .minus").removeClass("disabled"),$(t[e]).find(".tb-number .plus").removeClass("disabled")),parseInt(n)>=parseInt(a)?$(t[e]).find(".tb-number .plus").addClass("disabled"):$(t[e]).find(".tb-number .plus").removeClass("disabled"),parseInt(n)<=parseInt(i)?$(t[e]).find(".tb-number .minus").addClass("disabled"):$(t[e]).find(".tb-number .minus").removeClass("disabled")}},numMinus:function(t){if(evt=$(t),!evt.hasClass("disabled")){var e=evt.siblings("input").val();pop.is_multiple(evt),evt.siblings("input").val(e),evt.siblings(".plus").hasClass("disabled")&&evt.siblings(".plus").removeClass("disabled");var a=parseInt(evt.siblings("input").attr("value")),i=parseInt(evt.siblings("input").attr("min_per_user")),n=parseInt(evt.siblings("input").attr("user_can_bought"));IsNumeric(a)?(a--,i?i>=a&&evt.addClass("disabled"):1>=a&&evt.addClass("disabled"),evt.siblings("input").attr("value",a),parseInt(a)>parseInt(n)&&(alert("最多购买 "+n+"件"),evt.siblings("input").val(n),evt.siblings(".plus").addClass("disabled"))):pop.plusOne(evt)}},numPlus:function(t){evt=$(t);var e=evt.siblings("input").val();pop.is_multiple(evt),evt.siblings("input").val(e);{var a=parseInt(evt.siblings("input").val()),i=parseInt(evt.siblings("input").attr("user_can_bought"));parseInt(evt.parents("dd").attr("max_per_user"))}return evt.hasClass("disabled")?void(a>=i&&(alert("最多购买"+i+"件"),evt.siblings("input").val(i))):void(IsNumeric(a)?(a++,evt.siblings(".minus").hasClass("disabled")&&evt.siblings(".minus").removeClass("disabled"),evt.prev("input").attr("value",a),a>=i&&evt.addClass("disabled")):pop.plusOne(evt))
},numEnter:function(t){evt=$(t);var e=evt.val();pop.is_multiple(evt),evt.val(e);{var a=evt.attr("value"),i=parseInt(evt.attr("min_per_user")),n=parseInt(evt.attr("user_can_bought"));parseInt(evt.parents("dd").attr("max_per_user"))}0>=i&&(i=1),IsNumeric(a)?(i>=a?(a=i,evt.siblings(".minus").addClass("disabled"),evt.siblings(".plus").removeClass("disabled")):a>n?(alert("最多可购买"+n),a=n,evt.siblings(".plus").addClass("disabled"),evt.siblings(".minus").removeClass("disabled")):a==n?(evt.siblings(".plus").addClass("disabled"),evt.siblings(".minus").removeClass("disabled")):(evt.siblings(".plus").removeClass("disabled"),evt.siblings(".minus").removeClass("disabled")),i==n&&(evt.siblings(".plus").addClass("disabled"),evt.siblings(".minus").addClass("disabled")),evt.attr("value",a)):(a=i,evt.attr("value",i),evt.siblings(".minus").addClass("disabled"),n>i?evt.siblings(".plus").removeClass("disabled"):evt.siblings(".plus").addClass("disabled"))},is_multiple:function(t){if(type=t.parent().siblings("label").find("input").attr("type"),"radio"==type){for(var e=$(".type-branch .tb-number input"),a=0;a<e.length;a++)$(e[a]).val("");return 1}return 0},editNum:function(t){evt=$(t);var e=evt.val();if(!(e>0)){pop.is_multiple(evt),evt.parent().siblings("label").find("input").attr("checked","checked");var a=parseInt(evt.attr("min_per_user"));evt.val(a?a:1),this.plusSate()}},dataFill:function(t,e){var a="",i=$('input[name="amount_str['+buy.editGoodId+']"]').val(),n=!0;if($("#product-type .pop-title").html(e),t.cities){var s=$('<div class="branch-select"></div>'),r=$("<select></select>");r.append('<option value="0">全部城市</option>');for(var o in t.cities){var l=$('<option value="'+o+'">'+t.cities[o]+"</option>");r.append(l)}if(s.append(r),t.districts){var r=$("<select></select>");r.append('<option id="allArea" value="0">全部地区</option>');for(var o in t.districts)for(var d in t.districts[o]){var l=$('<option city="'+o+'" value="'+d+'">'+t.districts[o][d]+"</option>");r.append(l),r.append(l)}s.append(r)}$(".tb-button").css("padding-top","5px"),$(".pop-title").after(s)}else $(".branch-select").remove();poptype=t.multiple,t=t.data;for(var p in t){var c=0,u=parseInt(t[p].max_bought)-parseInt(t[p].sold);0==t[p].max_bought?c=t[p].user_can_bought:u>0&&u>=t[p].min_per_user&&(c=u<t[p].user_can_bought?u:t[p].user_can_bought),a+="<dd ",n&&(a+='class="bg" '),a+='sub_goods_id="'+t[p].sub_goods_id+'" min_per_user="1" max_per_user="'+t[p].max_per_user+'" user_can_bought="'+c+'">',n=!n;var h=subStrToNum(t[p].sub_goods_id,i);a+=poptype?h?0==c?'<label><input type="checkbox" name="type" hidefocus="true" onclick="pop.checkToggle(this)" /><span>'+t[p].title+"</span></label>":'<label><input type="checkbox" checked="checked" name="type" hidefocus="true" onclick="pop.checkToggle(this)" /><span>'+t[p].title+"</span></label>":'<label><input type="checkbox" name="type" hidefocus="true" onclick="pop.checkToggle(this)" /><span>'+t[p].title+"</span></label>":h?'<label><input type="radio" checked="checked" name="type" hidefocus="true" onclick="pop.checkToggle(this)" /><span>'+t[p].title+"</span></label>":'<label><input type="radio" name="type" hidefocus="true" onclick="pop.checkToggle(this)" /><span>'+t[p].title+"</span></label>",a+='<div class="tb-number">',0==c?a+="<em>已卖光</em>":(a+='<span class="minus',t[p].min_per_user>=h&&(a+=" disabled"),a+='" onclick="pop.numMinus(this)"><i class="narrow-icon"></i></span>						<input type="text" value="'+h+'" onfocus="pop.editNum(this)" onkeyup="pop.numEnter(this)" min_per_user="1" user_can_bought="'+c+'"/>						<span class="plus" onclick="pop.numPlus(this)"><i class="narrow-icon"></i></span>'),a+="</div></dd>"}if(this.dataBox.html(""),this.dataBox.append($(a)),"buy"==_switch&&amount instanceof Array){for(var o in amount)$('dd[sub_goods_id="'+o+'"]').find('input[type="radio"]').attr("checked","checked"),$('dd[sub_goods_id="'+o+'"]').find('input[type="text"]').val(amount[o]);amount=""}this.branchFilter()},branchFilter:function(){$(".branch-select select:first").change(function(t){var e=$(t.currentTarget).val();if($("#allArea").attr("selected","selected"),0==e)$(".type-branch dd").show(),$(".branch-select select:eq(1) option").show();else{for(var a=$("#allArea").siblings(),i=0;i<a.length;i++){var n=a[i];$(n).attr("city")==e?$(n).show():$(n).hide()}for(var s=$(".branch-select select:first option:selected").html(),r=$(".type-branch label span"),i=0;i<r.length;i++){var o=$(r[i]).html();o.indexOf(s)>=0?$(r[i]).parents("dd").show():$(r[i]).parents("dd").hide()}}}),$(".branch-select select:eq(1)").change(function(t){var e=$(t.currentTarget).val(),a=$(".branch-select select:first").val(),i=$(".branch-select select:first option:selected").html(),n=$(t.currentTarget).find("option:selected").html();if(0==e)if(0==a)var s=$(".type-branch dd").show();else for(var s=$(".type-branch label span"),r=0;r<s.length;r++){var o=$(s[r]).html();o.indexOf(i)>=0?$(s[r]).parents("dd").show():$(s[r]).parents("dd").hide()}else{var s=$(".type-branch label span");if(0==a)for(var r=0;r<s.length;r++){var o=$(s[r]).html();o.indexOf(n)>=0?$(s[r]).parents("dd").show():$(s[r]).parents("dd").hide()}else for(var r=0;r<s.length;r++){var o=$(s[r]).html();o.indexOf(i)>=0&&o.indexOf(n)>=0?$(s[r]).parents("dd").show():$(s[r]).parents("dd").hide()}}})},subOk:function(){if(this.dataToSet()){var t=this.subSet,e=0,a="",i="";"分店和数量"==this.popTitle?a+='<dl class="choose-content"><dt><span class="left">分店</span><span class="right">数量</span></dt>':i+='<dl class="choose-content"><dt><span class="left">类型</span><span class="right">数量</span></dt>';for(var n=0;n<t.length;n++)e+=parseInt(t[n][2]),a+=t[n][0]+":"+t[n][2],i+='<dd><span class="left" title="'+t[n][1]+'">'+t[n][1]+'</span><span class="right">'+t[n][2]+"</span></dd>",n!=t.length-1&&(a+="|");var s=$('.cart-list[goods_id="'+buy.editGoodId+'"]').find(".quantity").attr("user_can_bought"),r=$('.cart-list[goods_id="'+buy.editGoodId+'"]').find(".quantity").attr("min_per_user");if(isNaN(e)||""==e)return alert("请正确选择数量"),!1;if(r>e)return alert("此商品最少购买"+r+"件，请重新选择"),!1;if(e>s)return alert("此商品最多购买"+s+"件，请重新选择"),!1;i+="分店和数量"==this.popTitle?'<dd class="modify"><a href="javascript:void(0);" hint="分店" onclick="buy.getSubGoods(this)">修改</a></dd></dl>':'<dd class="modify"><a href="javascript:void(0);" hint="类型" onclick="buy.getSubGoods(this)">修改</a></dd></dl>';var o=this.resultSet();o&&(o.replaceWith($(i)),$('input[name="amount_str['+buy.editGoodId+']"]').val(a)),$('.cart-list[goods_id="'+buy.editGoodId+'"]').find(".quantity").attr("pronum",e),$('.cart-list[goods_id="'+buy.editGoodId+'"]').find(".quantity").find('input[title="total_num"]').val(e),buy.toPrice($('.cart-list[goods_id="'+buy.editGoodId+'"]'),this.totalNum()),this.close()}},dataToSet:function(){var t=this.dataBox.find("input:checked");this.subSet=new Array;for(var e=0;e<t.length;e++){var a=new Array;a[0]=$(t[e]).parents("dd").attr("sub_goods_id"),a[1]=$(t[e]).siblings("span").html(),a[2]=$(t[e]).parent().siblings(".tb-number").find("input").val(),this.subSet.push(a)}return 0==this.subSet.length?(alert("请确定您选择的数量正确"),!1):!0},totalNum:function(){for(var t=this.subSet,e=0,a=0;a<t.length;a++)e+=parseInt(t[a][2]);return e},resultSet:function(){var t=$('.cart-list[goods_id="'+buy.editGoodId+'"]'),e=t.find(".choose-title"),a=t.find(".choose-content");return e.length?e:a.length?a:!1},checkToggle:function(t){return evt=t.currentTarget?t.currentTarget:t,$(evt).parents("dd").find(".tb-number").find("em").length>0?void(evt.checked=!1):("radio"==$(evt).attr("type")&&$('.type-branch dd input[type="text"]').val(""),evt.checked?$(evt).parent().siblings(".tb-number").find("input").val($(evt).parent().attr("min_per_user")>0?$(evt).parent().attr("min_per_user"):"1"):$(evt).parents().siblings(".tb-number").find("input").val(""),void pop.plusSate())},plusOne:function(t){t.parent().siblings("label").find("input").attr("checked",!0),t.siblings("input").val(t.parents("dd").attr("min_per_user")>0?t.parents("dd").attr("min_per_user"):"1"),pop.plusSate()},subFinish:function(t){var e=$('.cart-list[goods_id="'+t+'"]').find(".quantity"),a=parseInt(e.attr("pronum")),i=parseInt(e.attr("min_per_user")),n=parseInt(e.attr("user_can_bought"));return i>a||a>n||!a?(e.find(".tips").addClass("error"),!1):(e.find(".tips").removeClass("error"),!0)}},bindMob={api:{getCode:"/account/mobilebind/newbindsendsms/",bind:"/account/mobilebind/newbindsmsverify/"},contain:$(".buy-phone"),msgTime:"",errTime:0,init:function(){$(".inbutton").click(function(t){bindMob.sendMsg(t)})},sendMsg:function(t){var e=this.contain.find("#bindphone").val(),a=$(t.currentTarget);if(!a.hasClass("disabled")){if(!isRealphone(e))return void $("#bindphone").next(".tips").addClass("error").find("span").html("请输入正确的手机号码");var i=this;$.ajax({type:"get",url:i.api.getCode,datatype:"json",data:{mobile:e},success:function(t){var n=120;if(a.addClass("disabled"),"0"==t.status)a.parents(".button").next(".cl").show(),a.parents(".button").siblings(".submit").show();else{if("15"==t.errno)return void(window.confirm(t.errmsg)?$.ajax({type:"get",url:i.api.getCode,datatype:"json",data:{mobile:e,remove_bind:1},success:function(t){var e=120;a.addClass("disabled"),"0"==t.status?(a.parents(".button").next(".cl").show(),a.parents(".button").siblings(".submit").show()):("10"==t.errno&&(e=t.timeout),$("#bindphone").next(".tips").addClass("error").find("span").html(t.errmsg)),e=parseInt(e)+1,a.val("重新获取("+e+")"),a.attr("time",e),bindMob.msgAgain()}}):(n=t.timeout,n=parseInt(n)+1,a.val("重新获取("+n+")"),a.attr("time",n),bindMob.msgAgain()));"10"==t.errno&&(n=t.timeout),$("#bindphone").next(".tips").addClass("error").find("span").html(t.errmsg)}n=parseInt(n)+1,a.val("重新获取("+n+")"),a.attr("time",n),bindMob.msgAgain()}})}},msgAgain:function(){var t=parseInt($(".inbutton").attr("time"));0==t?(clearTimeout(this.msgTime),$(".inbutton").removeClass("disabled"),$(".inbutton").val("重新获取")):(t--,$(".inbutton").attr("time",t),$(".inbutton").val("重新获取("+t+")"),this.msgTime=setTimeout("bindMob.msgAgain()",1e3))},postCode:function(){var t=this.contain.find("#bindphone").val(),e=this.contain.find("#msgcode").val();this.check_code(t,e)&&$.ajax({type:"post",url:this.api.bind,datatype:"json",data:{mobile:t,code:e},success:function(e){if("0"==e.status){var a=hidePhone(t);a&&($(".buy-botton").prepend('<p class="photo"><span>购买成功后拉手券将发送至手机：</span><em>'+a+'</em><a target="_blank" href="/account/setting/setbinds/">修改绑定手机号</a></p>'),$("#phone_block").remove())}else alert(e.errmsg)}})},check_code:function(t,e){return isRealphone(t)?""==e?($("#msgcode").siblings(".tips").find("span").html("动态码不能为空"),$("#msgcode").siblings(".tips").addClass("error"),$("#msgcode").addClass("error"),!1):e.length>=4?!0:($("#msgcode").siblings(".tips").find("span").html("动态码不正确"),$("#msgcode").siblings(".tips").addClass("error"),$("#msgcode").addClass("error"),!1):($("#bindphone").siblings(".tips").addClass("error"),$("#bindphone").siblings(".tips").find("span").html("请输入正确的手机号码"),$("#bindphone").addClass("error"),!1)}},payPassObj={api:{msg:"/account/paypwd/settingsendsms/",send:"/account/paypwd/settingsmsverify/"},input_pass:$("#payPass"),input_pass_sure:$("#pay_pass_sure"),cutdownTime:"",financeSubmit:!1,init:function(){var t=this;if($(".inbutton").click(function(e){t.sendmsg(e)}),$('.pay-password .submit input[type="button"]').click(function(){t.sendPay()}),$(".pay-password .submit a").click(function(){$('.pay-balance input[name="balance"]').attr("checked",!1);var e=$('.pay-balance input[name="balance"]')[0];t.balanceSel(e)}),$(".pay-balance input").click(function(e){t.balanceSel(e)}),spike&&t.payTime(),$(".bank li img").click(function(t){$(t.currentTarget).prev("input").attr("checked","checked")}),$("#finance_info").length>0)if($("#finance_info .input-warp").length>0){$('input[name="bank_deposit"]').parents(".handy-dropdown").hover(function(){},function(){$(this).removeClass("handy-dropdown-unfold")}),$('input[name="province"]').parents(".handy-dropdown").hover(function(){},function(){$(this).removeClass("handy-dropdown-unfold")}),$('input[name="city"]').parents(".handy-dropdown").hover(function(){},function(){$(this).removeClass("handy-dropdown-unfold")});for(var e in province){var a=$('<a data-province="'+e+'" href="javascript:void(0);" hidefocus="true">'+province[e]+"</a>");a.click(function(){var t=$(this).attr("data-province"),e=$(this).html();$('input[name="province"]').val(t),$('input[name="province"]').siblings(".handy-inputwarp").find("span").html(e),$('input[name="city"]').val(""),$('input[name="city"]').siblings(".handy-inputwarp").find("span").html("市"),$('input[name="city"]').next(".handy-dropdowncen").html("");for(var a in city[t]){var i=city[t],n=$('<a data-city="'+a+'" href="javascript:void(0);" hidefocus="true">'+i[a]+"</a>");n.click(function(){var t=$(this).attr("data-city"),e=$(this).html();$('input[name="city"]').val(t),$('input[name="city"]').siblings(".handy-inputwarp").find("span").html(e)}),n.appendTo($('input[name="city"]').next(".handy-dropdowncen"))}}),a.appendTo($('input[name="province"]').next(".handy-dropdowncen"))}$('input[name="bank_deposit"]').next(".handy-dropdowncen").find("a").click(function(){var t=$(this).html();$('input[name="bank_deposit"]').val(t),$('input[name="bank_deposit"]').siblings(".handy-inputwarp").find("span").html(t)}),$('input[name="bank_card"]').keyup(function(){var t=$(this).val().replace(/[ ]/g,"");if(t.length>=4){for(var e="",a=0;4*a<=t.length;a++)e+=t.substr(4*a,4)+" ";$(this).val($.trim(e))}})}else{var i=$("#finance_info li:eq(4) label:eq(1) span:eq(0)").html();$("#finance_info li:eq(4) label:eq(1) span:eq(0)").html(province[i]);var n=$("#finance_info li:eq(4) label:eq(1) span:eq(1)").html();$("#finance_info li:eq(4) label:eq(1) span:eq(1)").html(city[i][n]),this.financeSubmit=!0}},sendmsg:function(t){var e=$(t.currentTarget);if(e.hasClass("disabled"))return!1;this.input_pass.val(),this.input_pass_sure.val();return payPassObj.passCheck()?(e.addClass("disabled"),e.val("重新获取(121)"),e.attr("time",121),bindMob.msgAgain(),void $.ajax({type:"post",url:this.api.msg,datatype:"json",data:{},success:function(t){"0"==t.status?e.next(".tips").addClass("correct"):alert(t.errmsg)}})):!1},sendPay:function(){var t=$("#msgtext").val(),e=this.input_pass.val(),a=this.input_pass_sure.val();return payPassObj.passCheck()?""==t?($("#msgtext").next(".tips").addClass("error"),$("#msgtext").next(".tips").find("span").html("动态码不能为空"),!1):4!=t.length?($("#msgtext").next(".tips").addClass("error"),$("#msgtext").next(".tips").find("span").html("动态码错误"),!1):void $.ajax({type:"post",url:this.api.send,datatype:"json",data:{passwd:e,passwd2:a,code:t},success:function(t){if(0==t.status){$(".pay-password").remove();var e='<ul class="pay-password">									<li class="cl">										<label>支付密码</label>										<div class="input-warp">											<input class="intext" name="pay_pass" type="password" onfocus="inputOnfocus(this);" onblur="inputOnblur(this);" value="">											<a class="forget" href="/account/paypasswd/forget/">忘记支付密码？</a>											<p class="tips"><i class="pop-icon"></i><span>报错信息</span></p>										</div>									</li>								</ul>';$(".pay-balance").after(e)}else alert(t.errmsg)}}):!1},passCheck:function(){var t=this.input_pass.val(),e=this.input_pass_sure.val();if(t)if(e){var a=/[0-9]+/,i=/[a-zA-Z]+/,n=/[_|\-|+|=|*|!|@|#|$|%|^|&|(|)|'|\"|`]+/,s=0;if(a.test(t)&&s++,i.test(t)&&s++,n.test(t)&&s++,t.length>=6&&s>1){if(e==t)return!0;this.input_pass_sure.next(".tips").addClass("error")}else this.input_pass.next(".tips").find("span").html("6位以上的字母、数字或符号的组合,且不能与登录密码相同"),this.input_pass.next(".tips").addClass("error")}else this.input_pass_sure.next(".tips").addClass("error");else this.input_pass.next(".tips").addClass("error"),this.input_pass.next(".tips span").html("6位以上的字母、数字或符号的组合,且不能与登录密码相同");return!1},balanceSel:function(t){if(t.currentTarget)var e=$(t.currentTarget);else var e=$(t);if(e.attr("checked")){e.parent().next().slideDown("500");var a=parseFloat(e.siblings("em").find("b").html()),i=parseFloat($(".buy-details dt strong").html()),n=accSub(i,a);i>a?(e.siblings(".has-pay").find("em").html(a),$(".money-details p:first strong").html(a),$(".money-details p:last strong").html(n)):(e.siblings(".has-pay").find("em").html(i),$(".money-details p:first strong").html(i),$(".money-details p:last strong").html(0),$(".pay-bank").hide(),$("#finance_info").hide()),$(".pay-bank .has-pay em b").html(n)}else{e.parent().next().slideUp("500");var i=parseFloat($(".buy-details dt strong").html());i>0&&($(".pay-bank .has-pay em b").html(i),$(".pay-bank").show(),$("#finance_info").show()),$(".money-details p:last strong").html(i),$(".money-details p:first strong").html("0"),$(".pay-balance .has-pay em").html("0")}},payTime:function(){var t=$(".pay-modify p em"),e=$("#feedback .pop-title span");isNaN(buyTime)&&(buyTime=new Date(buyTime.replace(/-/g,"/")),buyTime=buyTime.getTime()),nowTime=parseInt(nowTime),0==$(".pay-modify p").find(":visible").length&&$(".pay-modify p").show();var a=900-nowTime+buyTime/1e3,i=parseInt(a/60),n=parseInt(a%60);0>a&&(i=0,n=0,clearInterval(this.cutdownTime)),t.find("span:first").html(i),e.find("em:first").html(i),t.find("span:last").html(n),e.find("em:last").html(n),nowTime+=1,this.cutdownTime=setTimeout("payPassObj.payTime()",1e3)},formCheck:function(){var t=$(".pay-balance input").attr("checked");if(t){var e=$(".pay-password .intext").val();if(""==e)return $(".pay-password .tips span").html("请输入支付密码"),$(".pay-password .tips").addClass("error"),!1;var a=/[0-9]+/,i=/[a-zA-Z]+/,n=/[_|\-|+|=|*|!|@|#|$|%|^|&|(|)|'|\"|`]+/,s=0;if(a.test(e)&&s++,i.test(e)&&s++,n.test(e)&&s++,2>s)return $(".pay-password .tips span").html("6位以上的字母、数字或符号的组合"),$(".pay-password .tips").addClass("error"),!1}if($(".pay-bank:visible").length>0){for(var r=$('input[type="radio"][name="bank_name"]'),o=!1,l=0;l<r.length;l++)r[l].checked&&(o=!0);if(!o)return alert("请选择银行"),!1}return $("#finance_info").length>0&&$(".pay-bank:visible").length>0?($("#payForm").attr("target","iframeLayer"),this.financeSubmit?this.saveFinance():(WYPLUS.open({formId:"payForm",iframeId:"iframeLayer"}),!0)):($("#payForm").attr("target","_blank"),this.popshow(),!0)},popshow:function(){$("body").append($('<div id="shadowlayer" style="display:block"></div>')),$("#feedback").css("margin-top","-117px"),$("#feedback").show()},pophide:function(){$("#shadowlayer").remove(),$("#feedback").hide()},saveFinance:function(){var t={uid:uid,real_name:$('input[name="real_name"]').val(),identity:$('input[name="identity"]').val(),bank_deposit:$('input[name="bank_deposit"]').siblings(".handy-inputwarp").find("span").html(),bank_card:$('input[name="bank_card"]').val(),province:$('input[name="province"]').val(),province_name:$('input[name="province"]').siblings(".handy-inputwarp").find("span").html(),city:$('input[name="city"]').val(),city_name:$('input[name="city"]').siblings(".handy-inputwarp").find("span").html(),mobile:$('input[name="mobile"]').val(),type:1};if(!is_name(t.real_name))return $('input[name="real_name"]').siblings(".tips").addClass("error"),!1;if($('input[name="real_name"]').siblings(".tips").removeClass("error"),!is_identity(t.identity))return $('input[name="identity"]').siblings(".tips").addClass("error"),!1;if($('input[name="identity"]').siblings(".tips").removeClass("error"),"请选择开户银行"==t.bank_deposit)return $('input[name="bank_deposit"]').parent().siblings(".tips").addClass("error"),!1;if($('input[name="bank_deposit"]').parent().siblings(".tips").removeClass("error"),!is_bankcard(t.bank_card))return $('input[name="bank_card"]').siblings(".tips").addClass("error"),!1;if($('input[name="bank_card"]').siblings(".tips").removeClass("error"),!t.province)return $('input[name="province"]').parent().siblings(".tips").addClass("error"),!1;if($('input[name="province"]').parent().siblings(".tips").removeClass("error"),!t.city)return $('input[name="city"]').parent().siblings(".tips").addClass("error"),!1;if($('input[name="city"]').parent().siblings(".tips").removeClass("error"),!isRealPhone(t.mobile))return $('input[name="mobile"]').siblings(".tips").addClass("error"),!1;$('input[name="mobile"]').siblings(".tips").removeClass("error");var e=this;return $.ajax({url:"/order/pay/setaccount/",type:"POST",dataType:"json",data:t,success:function(a){if(t.real_name.length>2){for(var i=t.real_name.substr(0,1),n=0;n<t.real_name.length-2;n++)i+="*";i+=t.real_name.substr(-1,1)}else var i=t.real_name.substr(0,1)+"*";if(1==a.status){var s='<li class="cl"><label>开户人</label><label style="text-align:left">'+i+'</label></li><li class="cl"><label>身份证号</label><label style="text-align:left">'+t.identity.substring(0,t.identity.length-4)+'****</label></li><li class="cl"><label>开户银行</label><label style="text-align:left">'+t.bank_deposit+'</label></li><li class="cl"><label>银行卡号</label><label style="text-align:left">'+t.bank_card.substring(0,4)+" **** **** "+t.bank_card.substring(15)+'</label></li><li class="cl"><label>开户行所在地</label><label style="text-align:left">'+t.province_name+t.city_name+'</label></li><li class="cl"><label>银行预留手机号</label><label style="text-align:left">'+t.mobile.substring(0,3)+"****"+t.mobile.substring(7)+"</label></li>";$("#finance_info").html(s),e.financeSubmit=!0,$('form[name="postpay"]').submit()}else{if("请您登录"==a.errmsg){var r=window.location.href;LS.alert(a.errmsg,"",function(){window.location.href=r})}LS.alert(a.errmsg)}},error:function(){}}),!1},payJump:function(){var t,e=$("#jump_time"),a=parseInt(e.html());isNaN(a)||(a>0?(a--,e.html(a),t=setTimeout("payPassObj.payJump()",1e3)):(window.location.href="/account/orders/type2/",clearTimeout(t)))}},charge={api:{phoneInfo:"/order/PhoneCharge/query/",chargeSub:"/order/PhoneCharge/submit/"},cont:$(".phone-recharge"),phone:$("#phone"),phone_sure:$("#phone_sure"),init:function(){this.phone.keyup(function(){charge.phoneChk()}),this.phone.blur(function(){11==charge.phone.val().length&&11==charge.phone_sure.val().length&&charge.phoneConfirm()}),this.phone_sure.blur(function(){charge.phoneConfirm()}),$(".radio-warp input").click(function(){charge.getChargeInfo()})},phoneChk:function(){var t=this.phone.val();isRealphone(t)?($(".pr-name").next(".tips").removeClass("error"),this.getChargeInfo()):11==t.length?($(".pr-name").html(""),$(".pr-name").next(".tips").find("span").html("请填写正确的手机号码"),$(".pr-name").next(".tips").removeClass("note"),$(".pr-name").next(".tips").addClass("error")):$(".pr-name").html("")},getChargeInfo:function(){var t=charge.phone.val();t&&(isRealphone(t)||(t="",$(".pr-name").next(".tips").removeClass("note"),$(".pr-name").next(".tips").addClass("error")));var e=$(".radio-warp input:checked").val();$.ajax({type:"get",url:this.api.phoneInfo,datatype:"json",data:{mobile:t,price:e},success:function(t){"0000"==t.code?($('.phone-recharge input[type="submit"]').attr("disabled",!1),$(".sell").html("<span>"+t.price+"<span>元"),t.goods_id&&($(".pr-name").html(t.message),$('input[name="goods_id"]').val(t.goods_id))):($('.phone-recharge input[type="submit"]').attr("disabled","disabled"),$(".sell").html(t.message))}})},phoneConfirm:function(){return Boolean(this.phone_sure.val())?this.phone.val()!==this.phone_sure.val()?(this.phone_sure.next(".tips").find("span").html("两次号码输入不一致"),this.phone_sure.next(".tips").addClass("error"),!1):(this.phone_sure.next(".tips").removeClass("error"),!0):(this.phone_sure.next(".tips").find("span").html("请再次输入确认手机号"),void this.phone_sure.next(".tips").addClass("error"))},sub:function(){var t=this.phone.val();if(t){if(isRealphone(t)){if(this.phoneConfirm()){var e=$('input[name="money"]:checked').val();return e?!0:!1}return!1}return $(".pr-name").html(""),$(".pr-name").next(".tips").find("span").html("手机号输入错误"),$(".pr-name").next(".tips").removeClass("note"),$(".pr-name").next(".tips").addClass("error"),!1}return!1}};